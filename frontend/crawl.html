<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crawl | Distributed Crawler</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="navbar">
        <span class="brand">Distributed Crawler</span>
        <nav>
            <a href="home.html">Home</a>
            <a href="crawl.html" class="active">Crawl</a>
            <a href="dashboard.html">Progress Dashboard</a>
            <a href="history.html">Crawl History</a>
        </nav>
    </div>
    <div class="container">
        <div class="section-title">Crawl Product URLs</div>
        <div class="card">
            <label for="urls">Enter URLs (one per line):</label>
            <textarea id="urls" placeholder="https://example.com\nhttps://another.com"></textarea>
            <button onclick="submitUrls()">Start Crawling</button>
            <button onclick="fetchResults()">Refresh Results</button>
            <div id="status" style="margin-top:1em;"></div>
            <div id="already-crawled-msg" style="margin-top:0.5em;color:#b00;font-size:0.98em;"></div>
        </div>
        <div id="progress-bar-container" style="margin-bottom:1.5em;"></div>
        <div class="section-title" style="margin-top:2em;">Crawl Results</div>
        <div class="card table-responsive">
            <div id="results"></div>
        </div>
    </div>
    <footer>
        &copy; 2025 Distributed Crawler &mdash; Parallel &amp; Distributed Computing Project
    </footer>
    <style>
    .progress-bar-bg {
        background: #e0e7ef;
        border-radius: 10px;
        height: 22px;
        width: 100%;
        margin-bottom: 0.5em;
        box-shadow: 0 2px 8px rgba(30,41,59,0.08);
        overflow: hidden;
    }
    .progress-bar-fill {
        background: linear-gradient(90deg, #38bdf8 0%, #06b6d4 100%);
        height: 100%;
        border-radius: 10px 0 0 10px;
        transition: width 0.4s cubic-bezier(.4,2,.6,1);
        text-align: right;
        color: #fff;
        font-weight: 600;
        font-size: 1em;
        padding-right: 1em;
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }
    </style>
    <script>
    let progressBarInterval = null;
    let currentSessionId = null;

    function showProgressBar() {
        updateProgressBar();
        if (!progressBarInterval) {
            progressBarInterval = setInterval(updateProgressBar, 1500);
        }
    }
    function hideProgressBar() {
        document.getElementById('progress-bar-container').innerHTML = '';
        if (progressBarInterval) {
            clearInterval(progressBarInterval);
            progressBarInterval = null;
        }
    }
    function updateProgressBar() {
        fetch('http://localhost:5000/progress')
        .then(res => res.json())
        .then(data => {
            const total = data.queued + data.results + data.failed;
            const done = data.results + data.failed;
            let percent = total > 0 ? Math.round((done / total) * 100) : 100;
            let bar = `<div class='progress-bar-bg'><div class='progress-bar-fill' style='width:${percent}%;'>${percent}%</div></div>`;
            document.getElementById('progress-bar-container').innerHTML = bar;
            if (percent >= 100) hideProgressBar();
        })
        .catch(() => {
            document.getElementById('progress-bar-container').innerHTML = '';
        });
    }

    function submitUrls() {
        const textarea = document.getElementById('urls');
        const urls = textarea.value.split('\n').map(u => u.trim()).filter(u => u);
        if (urls.length === 0) {
            alert('Please enter at least one URL.');
            return;
        }
        fetch('http://localhost:5000/submit-urls', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ urls })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById('status').innerText = `Submitted ${data.urls_added} URLs for crawling.`;
            if (data.already_crawled && data.already_crawled.length > 0) {
                document.getElementById('already-crawled-msg').innerHTML =
                  'Already crawled URLs:<br><ul style="margin:0.3em 0 0 1.2em;">' +
                  data.already_crawled.map(url => `<li>${url}</li>`).join('') + '</ul>';
            } else {
                document.getElementById('already-crawled-msg').innerHTML = '';
            }
            currentSessionId = data.session_id;
            showProgressBar();
            fetchResults();
        })
        .catch(err => {
            document.getElementById('status').innerText = 'Error submitting URLs.';
            document.getElementById('already-crawled-msg').innerHTML = '';
        });
    }
    function fetchResults() {
        let url = 'http://localhost:5000/results';
        if (currentSessionId) {
            url = `http://localhost:5000/results/${currentSessionId}`;
        }
        fetch(url)
        .then(res => res.json())
        .then(data => {
            const results = data.results || {};
            let html = '';
            if (Object.keys(results).length === 0) {
                html += '<p>No results yet.</p>';
            } else {
                html += '<table><tr><th>URL</th><th>Name</th><th>Price</th><th>Rating</th><th>Availability</th><th>Image</th><th>Description</th><th>Error</th></tr>';
                for (const [url, dataRaw] of Object.entries(results)) {
                    let data = dataRaw;
                    if (typeof data === 'string' && data.trim().startsWith('{') && data.trim().endsWith('}')) {
                        try { data = JSON.parse(data); } catch (e) { data = { error: dataRaw }; }
                    }
                    let name = data.name || '';
                    let price = data.price || '';
                    let rating = data.rating || '';
                    let availability = data.availability || '';
                    let image = data.image_url ? `<img src="${data.image_url}" alt="img" style="max-width:60px;max-height:60px;">` : '';
                    let description = data.description || '';
                    let error = data.error || '';
                    html += `<tr>
                        <td class='url-col' title='Click to expand/collapse'>${url}</td>
                        <td>${name}</td>
                        <td>${price}</td>
                        <td>${rating}</td>
                        <td>${availability}</td>
                        <td>${image}</td>
                        <td class='desc-col' title='Click to expand/collapse'>${description}</td>
                        <td>${error}</td>
                    </tr>`;
                }
                html += '</table>';
            }
            document.getElementById('results').innerHTML = html;
            // Add expand/collapse to description cells
            document.querySelectorAll('.desc-col, .url-col').forEach(cell => {
                cell.addEventListener('click', function() {
                    this.classList.toggle('expanded');
                });
            });
        })
        .catch(err => {
            document.getElementById('results').innerText = 'Error fetching results.';
        });
    }
    // Auto-refresh results every 5 seconds
    setInterval(fetchResults, 5000);
    fetchResults();
    </script>
</body>
</html>
