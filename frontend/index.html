
<!--
  Simple HTML Frontend for Distributed Web Crawler
  - Input field for multiple URLs
  - Button to trigger crawling
  - Fetches and displays aggregated crawl results
  - Interacts with Flask master server, which in turn uses Memurai (Redis)
-->

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Distributed Web Crawler</title>
	<style>
		body { font-family: Arial, sans-serif; margin: 2em; }
		textarea { width: 100%; height: 80px; }
		button { margin-top: 1em; padding: 0.5em 1em; }
		#results { margin-top: 2em; }
		table { border-collapse: collapse; width: 100%; }
		th, td { border: 1px solid #ccc; padding: 0.5em; }
		th { background: #f0f0f0; }
	</style>
</head>
<body>
	<h2>Distributed Web Crawler</h2>
	<label for="urls">Enter URLs (one per line):</label><br>
	<textarea id="urls" placeholder="https://example.com\nhttps://another.com"></textarea><br>

	<button onclick="submitUrls()">Start Crawling</button>
	<button onclick="fetchResults()">Refresh Results</button>

	<div id="dashboard">
		<h3>Progress Dashboard</h3>
		<div id="progress"></div>
		<h3>Worker Activity</h3>
		<div id="workers"></div>
	</div>

	<div id="status"></div>
	<div id="results"></div>

	<script>
	// Periodically update dashboard
	setInterval(() => {
		fetchProgress();
		fetchWorkers();
	}, 3000);

	function fetchProgress() {
		fetch('http://localhost:5000/progress')
		.then(res => res.json())
		.then(data => {
			let html = `<b>Queued:</b> ${data.queued} &nbsp; <b>Visited:</b> ${data.visited} &nbsp; <b>Completed:</b> ${data.results} &nbsp; <b>Failed:</b> ${data.failed}`;
			document.getElementById('progress').innerHTML = html;
		})
		.catch(() => {
			document.getElementById('progress').innerText = 'Error fetching progress.';
		});
	}

	function fetchWorkers() {
		fetch('http://localhost:5000/workers')
		.then(res => res.json())
		.then(data => {
			const workers = data.workers || {};
			let html = '<table><tr><th>Worker ID</th><th>Status / Current URL</th></tr>';
			for (const [wid, status] of Object.entries(workers)) {
				html += `<tr><td>${wid}</td><td>${status}</td></tr>`;
			}
			html += '</table>';
			document.getElementById('workers').innerHTML = html;
		})
		.catch(() => {
			document.getElementById('workers').innerText = 'Error fetching workers.';
		});
	}
	// Send URLs to Flask server
	function submitUrls() {
		const textarea = document.getElementById('urls');
		const urls = textarea.value.split('\n').map(u => u.trim()).filter(u => u);
		if (urls.length === 0) {
			alert('Please enter at least one URL.');
			return;
		}
		fetch('http://localhost:5000/submit-urls', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ urls })
		})
		.then(res => res.json())
		.then(data => {
			document.getElementById('status').innerText = `Submitted ${data.urls_added} URLs for crawling.`;
			fetchResults();
		})
		.catch(err => {
			document.getElementById('status').innerText = 'Error submitting URLs.';
		});
	}

	// Fetch and display crawl results
	function fetchResults() {
		fetch('http://localhost:5000/results')
		.then(res => res.json())
		.then(data => {
			const results = data.results || {};
			let html = '<h3>Crawl Results</h3>';
			if (Object.keys(results).length === 0) {
				html += '<p>No results yet.</p>';
			} else {
				html += '<table><tr><th>URL</th><th>Name</th><th>Price</th><th>Rating</th><th>Availability</th><th>Image</th><th>Description</th><th>Error</th></tr>';
				for (const [url, dataRaw] of Object.entries(results)) {
					let data = dataRaw;
					// If data is a string and looks like JSON, try to parse it
					if (typeof data === 'string' && data.trim().startsWith('{') && data.trim().endsWith('}')) {
						try {
							data = JSON.parse(data);
						} catch (e) {
							// If parsing fails, show the string in error column
							data = { error: dataRaw };
						}
					}
					let name = data.name || '';
					let price = data.price || '';
					let rating = data.rating || '';
					let availability = data.availability || '';
					let image = data.image_url ? `<img src="${data.image_url}" alt="img" style="max-width:60px;max-height:60px;">` : '';
					let description = data.description || '';
					let error = data.error || '';
					html += `<tr><td>${url}</td><td>${name}</td><td>${price}</td><td>${rating}</td><td>${availability}</td><td>${image}</td><td>${description}</td><td>${error}</td></tr>`;
				}
				html += '</table>';
			}
			document.getElementById('results').innerHTML = html;
		})
		.catch(err => {
			document.getElementById('results').innerText = 'Error fetching results.';
		});
	}
	</script>

	<!--
	  Frontend Explanation:
	  - The frontend does not interact with Memurai (Redis) directly.
	  - All communication is via HTTP requests to the Flask master server.
	  - Flask acts as an API gateway, handling URL submission and result retrieval.
	  - Flask then uses Memurai for distributed task coordination and result storage.
	-->
</body>
</html>
